import datetime as dt
import pandas as pd
import requests
from openpyxl import Workbook
import os

def events(tag, time_from, time_to):
    
    time_from = time_from.strftime('%Y-%m-%dT06:00:00')
    time_to = time_to.strftime('%Y-%m-%dT05:59:00')

    
    url = f'https://api.st-one.io/v1/mdiasbranco_gme/events/{tag}?timeFrom={time_from}&timeTo={time_to}'
    response = requests.get(url=url, headers={'Accept': 'application/json', 'Authorization': 'UbeGO4CmLDgMltQAP_ZA-e_cdW9xLc0Pc40RhRfsH_uD9htlo75V7o-zLMA_G3TR9xg9h5Q'})

    if response.status_code != 200:
        print(f"Erro ao acessar a API: {response.status_code}")
        return []

    return response.json()

def events_process(tags, time_from, time_to):
    historian = pd.DataFrame()

    for tag_info in tags:
        tag = tag_info['tag']  # Obter apenas a tag da informação
        cod = tag_info['cod']
        descricao = tag_info['descricao']
        data = events(tag, time_from, time_to)
        if not data:
            continue

        df = pd.DataFrame(data)
        df = df.drop(columns='info')
        df['cod'] = cod
        df['descricao'] = descricao
        df['envase'] = tag_info['envase']  # Adiciona a informação do envase
        historian = pd.concat([historian, df], axis=0)

    if historian.empty:
        print("O DataFrame historian está vazio após o processamento dos eventos.")
        return historian

    historian['time'] = pd.to_datetime(historian['time'])
    historian['time'] = historian['time'].dt.tz_localize(None)  # Remover o timezone
    historian = historian.drop_duplicates(subset=['time', 'cod', 'descricao'])

    # Somar os valores para cada dia e cada cilindro
    historian['value'] = pd.to_numeric(historian['value'], errors='coerce')  # Converter para numérico
    historian = historian.groupby(['cod', 'descricao', 'envase']).agg({'value': 'sum'}).reset_index()

    return historian

# Adicione manualmente as tags conforme necessário
tags = [{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.1","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.2","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.3","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.4","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.5","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 5","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].0","cod":"O_V1.1.6","descricao":"Dispensador de baldes 1 | Eletroválvula 01, conjunto 1, cilindro 6","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.1","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.2","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.3","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.4","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.5","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 5","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].2","cod":"O_V2.1.6","descricao":"Dispensador de baldes 2 | Eletroválvula 02, conjunto 1, cilindro 6","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].4","cod":"O_V3.1.1","descricao":"Pegador de baldes | Eletroválvula 03, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].4","cod":"O_V3.1.2","descricao":"Pegador de baldes | Eletroválvula 03, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].4","cod":"O_V3.1.3","descricao":"Pegador de baldes | Eletroválvula 03, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].4","cod":"O_V3.1.4","descricao":"Pegador de baldes | Eletroválvula 03, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.1.1","descricao":"Freio de Baldes 1 | Eletroválvula 04, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.1.2","descricao":"Freio de Baldes 1 | Eletroválvula 04, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.1.3","descricao":"Freio de Baldes 1 | Eletroválvula 04, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.1.4","descricao":"Freio de Baldes 1 | Eletroválvula 04, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.3.1","descricao":"Freio de Baldes 3 | Eletroválvula 04, conjunto 3, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.3.2","descricao":"Freio de Baldes 3 | Eletroválvula 04, conjunto 3, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.3.3","descricao":"Freio de Baldes 3 | Eletroválvula 04, conjunto 3, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.3.4","descricao":"Freio de Baldes 3 | Eletroválvula 04, conjunto 3, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.5.1","descricao":"Freio de baldes 5 | Eletroválvula 04, conjunto 5, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.5.2","descricao":"Freio de baldes 5 | Eletroválvula 04, conjunto 5, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.5.3","descricao":"Freio de baldes 5 | Eletroválvula 04, conjunto 5, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].6","cod":"O_V4.5.4","descricao":"Freio de baldes 5 | Eletroválvula 04, conjunto 5, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.2.1","descricao":"Freio de baldes 2 | Eletroválvula 05, conjunto 2, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.2.2","descricao":"Freio de baldes 2 | Eletroválvula 05, conjunto 2, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.2.3","descricao":"Freio de baldes 2 | Eletroválvula 05, conjunto 2, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.2.4","descricao":"Freio de baldes 2 | Eletroválvula 05, conjunto 2, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.4.1","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 4, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.4.2","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 4, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.4.3","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 4, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.4.4","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 4, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.6.1","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 6, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.6.2","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 6, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.6.3","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 6, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].8","cod":"O_V5.6.4","descricao":"Freio de baldes 4 | Eletroválvula 05, conjunto 6, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].14","cod":"O_V8.1.1","descricao":"Libera tampa 1 | Eletroválvula 08, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].14","cod":"O_V8.1.2","descricao":"Libera tampa 1 | Eletroválvula 08, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].14","cod":"O_V8.1.3","descricao":"Libera tampa 1 | Eletroválvula 08, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].14","cod":"O_V8.1.4","descricao":"Libera tampa 1 | Eletroválvula 08, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].16","cod":"O_V9.1.1","descricao":"Libera tampa 2 | Eletroválvula 09, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].16","cod":"O_V9.1.2","descricao":"Libera tampa 2 | Eletroválvula 09, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].16","cod":"O_V9.1.3","descricao":"Libera tampa 2 | Eletroválvula 09, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].16","cod":"O_V9.1.4","descricao":"Libera tampa 2 | Eletroválvula 09, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.1.1","descricao":"Freio de tampa 1 | Eletroválvula 10, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.1.2","descricao":"Freio de tampa 1 | Eletroválvula 10, conjunto 1, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.1.3","descricao":"Freio de tampa 1 | Eletroválvula 10, conjunto 1, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.1.4","descricao":"Freio de tampa 1 | Eletroválvula 10, conjunto 1, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.3.1","descricao":"Freio de tampa 3 | Eletroválvula 10, conjunto 3, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.3.2","descricao":"Freio de tampa 3 | Eletroválvula 10, conjunto 3, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.3.3","descricao":"Freio de tampa 3 | Eletroválvula 10, conjunto 3, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.3.4","descricao":"Freio de tampa 3 | Eletroválvula 10, conjunto 3, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.5.1","descricao":"Freio de tampa 5 | Eletroválvula 10, conjunto 5, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.5.2","descricao":"Freio de tampa 5 | Eletroválvula 10, conjunto 5, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.5.3","descricao":"Freio de tampa 5 | Eletroválvula 10, conjunto 5, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.5.4","descricao":"Freio de tampa 5 | Eletroválvula 10, conjunto 5, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.7.1","descricao":"Freio de tampa 7 | Eletroválvula 10, conjunto 7, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.7.2","descricao":"Freio de tampa 7 | Eletroválvula 10, conjunto 7, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.7.3","descricao":"Freio de tampa 7 | Eletroválvula 10, conjunto 7, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].18","cod":"O_V10.7.4","descricao":"Freio de tampa 7 | Eletroválvula 10, conjunto 7, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.2.1","descricao":"Freio de tampa 2 | Eletroválvula 11, conjunto 2, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.2.2","descricao":"Freio de tampa 2 | Eletroválvula 11, conjunto 2, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.2.3","descricao":"Freio de tampa 2 | Eletroválvula 11, conjunto 2, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.2.4","descricao":"Freio de tampa 2 | Eletroválvula 11, conjunto 2, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.4.1","descricao":"Freio de tampa 4 | Eletroválvula 11, conjunto 4, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.4.2","descricao":"Freio de tampa 4 | Eletroválvula 11, conjunto 4, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.4.3","descricao":"Freio de tampa 4 | Eletroválvula 11, conjunto 4, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.4.4","descricao":"Freio de tampa 4 | Eletroválvula 11, conjunto 4, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.6.1","descricao":"Freio de tampa 6 | Eletroválvula 11, conjunto 6, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.6.2","descricao":"Freio de tampa 6 | Eletroválvula 11, conjunto 6, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.6.3","descricao":"Freio de tampa 6 | Eletroválvula 11, conjunto 6, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.6.4","descricao":"Freio de tampa 6 | Eletroválvula 11, conjunto 6, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.8.1","descricao":"Freio de tampa 8 | Eletroválvula 11, conjunto 8, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.8.2","descricao":"Freio de tampa 8 | Eletroválvula 11, conjunto 8, cilindro 2","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.8.3","descricao":"Freio de tampa 8 | Eletroválvula 11, conjunto 8, cilindro 3","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].20","cod":"O_V11.8.4","descricao":"Freio de tampa 8 | Eletroválvula 11, conjunto 8, cilindro 4","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].22","cod":"O_V12.1.1","descricao":"Pressionador de tampa 01 | Eletroválvula 12, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].24","cod":"O_V13.1.1","descricao":"Pressionador de tampa 02 | Eletroválvula 13, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[16].26","cod":"O_V14.1.1","descricao":"Extrator de baldes | Eletroválvula 14, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].0","cod":"O_V21.1.1","descricao":"Embolo dosador 04 | Eletroválvula 21, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].2","cod":"O_V22.1.1","descricao":"Embolo dosador 03 | Eletroválvula 22, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].4","cod":"O_V23.1.1","descricao":"Embolo dosador 02 | Eletroválvula 23, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].6","cod":"O_V24.1.1","descricao":"Embolo dosador 01 | Eletroválvula 24, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].8","cod":"O_V25.1.1","descricao":"Embolo pulmão desce 02 | Eletroválvula 25, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].10","cod":"O_V26.1.1","descricao":"Embolo pulmão desce 01 | Eletroválvula 26, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].12","cod":"O_V27.1.1","descricao":"Embolo pulmão sobe 02 | Eletroválvula 27, conjunto 1, cilindro 1","envase":"Envase 05"},{"tag":"mdiasbranco_gme_mgr_l3_envase_05_Local:1:O.Data[18].14","cod":"O_V28.1.1","descricao":"Embolo pulmão sobe 01 | Eletroválvula 28, conjunto 1, cilindro 1","envase":"Envase 05"}]

# Define o intervalo de tempo para a consulta
end_date = dt.datetime.now().replace(hour=5, minute=59, second=0, microsecond=0)
start_date = end_date - dt.timedelta(days=1)

# Processa os eventos e gera o DataFrame com o histórico
historian_df = events_process(tags, start_date, end_date)

# Salva o DataFrame em um arquivo Excel no diretório fornecido
output_dir = r'C:\Users\ter07068\OneDrive - M DIAS BRANCO S.A. INDUSTRIA E COMERCIO DE ALIMENTOS\Área de Trabalho\Python\Excel'
file_path = os.path.join(output_dir, "historico.xlsx")
historian_df.to_excel(file_path, index=False)
print(f"Os dados foram salvos com sucesso no arquivo: {file_path}")
